<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon.ico?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon.ico?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon.ico?v=6.2.0">


  <link rel="mask-icon" href="/assets/images/favicon.ico?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.2.0',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="HBase,Tuning," />


<meta name="description" content="HBase is the big data store of choice for engineering at HubSpot. It’s a complicated data store with a multitude of levers and knobs that can be adjusted to tune performance. We’ve put a lot of effort">
<meta name="keywords" content="HBase,Tuning">
<meta property="og:type" content="article">
<meta property="og:title" content="Tuning G1GC For Your HBase Cluster">
<meta property="og:url" content="http://hyperj.github.com/2016/2016-05-10-g1gc-tuning-your-hbase-cluster/index.html">
<meta property="og:site_name" content="HyperJ&#39;s Blog!">
<meta property="og:description" content="HBase is the big data store of choice for engineering at HubSpot. It’s a complicated data store with a multitude of levers and knobs that can be adjusted to tune performance. We’ve put a lot of effort">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC1-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC2-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC3-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1Gc4-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC5-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC6-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC7-1.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC8.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC9.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC10.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC11.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC12.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC13.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC14.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC15.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC16.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC17.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC18.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC19.png">
<meta property="og:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC20.png">
<meta property="og:updated_time" content="2018-03-11T10:08:30.917Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tuning G1GC For Your HBase Cluster">
<meta name="twitter:description" content="HBase is the big data store of choice for engineering at HubSpot. It’s a complicated data store with a multitude of levers and knobs that can be adjusted to tune performance. We’ve put a lot of effort">
<meta name="twitter:image" content="http://hyperj.github.com/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC1-1.png">



  <link rel="alternate" href="/atom.xml" title="HyperJ's Blog!" type="application/atom+xml" />




  <link rel="canonical" href="http://hyperj.github.com/2016/2016-05-10-g1gc-tuning-your-hbase-cluster/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Tuning G1GC For Your HBase Cluster | HyperJ's Blog!</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?35d7ac00b108e4e02793e4abb6d9f575";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HyperJ's Blog!</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Knowledge makes me travel through time and space.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-work">
          <a href="/work/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />Work</a>
        </li>
      
        
        <li class="menu-item menu-item-projects">
          <a href="/projects/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />Projects</a>
        </li>
      
        
        <li class="menu-item menu-item-collections">
          <a href="/collections/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-list"></i> <br />Collections</a>
        </li>
      
        
        <li class="menu-item menu-item-specials">
          <a href="/specials/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-check-square"></i> <br />Specials</a>
        </li>
      
        
        <li class="menu-item menu-item-translations">
          <a href="/translations/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-exchange"></i> <br />Translations</a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-link"></i> <br />Links</a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Books</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />Search</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hyperj.github.com/2016/2016-05-10-g1gc-tuning-your-hbase-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HyperJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/assets/images/hyperj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HyperJ's Blog!">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Tuning G1GC For Your HBase Cluster</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-10T00:00:00+08:00">2016-05-10</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-03-11T18:08:30+08:00">2018-03-11</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HBase/" itemprop="url" rel="index"><span itemprop="name">HBase</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             Views: 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>HBase is the big data store of choice for engineering at HubSpot. It’s a complicated data store with a multitude of levers and knobs that can be adjusted to tune performance. We’ve put a lot of effort into optimizing the performance and stability of our HBase clusters, and recently discovered that suboptimal G1GC tuning was playing a big part in issues we were seeing, especially with stability.</p>
<p>Each of our HBase clusters is made up of 6 to 40 AWS d2.8xlarge instances serving terabytes of data. Individual instances handle sustained loads over 50k ops/sec with peaks well beyond that. This post will cover the efforts undertaken to iron out G1GC-related performance issues in these clusters. If you haven’t already, we suggest getting familiar with the <a href="http://product.hubspot.com/blog/g1gc-fundamentals-lessons-from-taming-garbage-collection" target="_blank" rel="noopener">characteristics, quirks, and terminology of G1GC</a> first.</p>
<p>We first discovered that G1GC might be a source of pain while investigating frequent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“...FSHLog: Slow sync cost: ### ms...”</span><br></pre></td></tr></table></figure>
<p>messages in our RegionServer logs. Their occurrence correlated very closely to GC pauses, so we dug further into RegionServer GC. We discovered three issues related to GC:</p>
<ul>
<li>One cluster was losing nodes regularly due to long GC pauses.</li>
<li>The overall GC time was between 15-25% during peak hours.</li>
<li>Individual GC events were frequently above 500ms, with many over 1s.</li>
</ul>
<p>Below are the 7 tuning iterations we tried in order to solve these issues, and how each one played out. As a result, we developed a step-by-step summary for tuning HBase clusters that you can find and follow here.</p>
<h3 id="Original-GC-Tuning-State"><a href="#Original-GC-Tuning-State" class="headerlink" title="Original GC Tuning State"></a>Original GC Tuning State</h3><p>The original JVM tuning was based on <a href="https://software.intel.com/en-us/blogs/2014/06/18/part-1-tuning-java-garbage-collection-for-hbase" target="_blank" rel="noopener">an Intel blog post</a>, and over time morphed into the following configuration just prior to our major tuning effort.</p>
<p>| Xmx32g -Xms32g | 32 GB heap, initial and max should be the same |<br>| XX:G1NewSizePercent= 3-9 | Minimum size for Eden each epoch, differs by cluster |<br>| XX:MaxGCPauseMillis=50 | Optimistic target, most clusters take  100+ ms |<br>| XX:-OmitStackTraceInFastThrow | Better stack traces in some circumstances, traded for a bit more  CPU usage |<br>| XX:+ParallelRefProcEnabled | Helps keep a lid on <a href="http://www.infoq.com/articles/tuning-tips-G1-GC" target="_blank" rel="noopener">reference processing time</a> issues were were seeing |<br>| XX:+PerfDisableSharedMem | Alleged to protect against <a href="http://www.evanjones.ca/jvm-mmap-pause.html" target="_blank" rel="noopener">bizarre linux issue</a> |<br>| XX:-ResizePLAB | Alleged to save some CPU cycles in between GC epochs |</p>
<p>GC logging verbosity as shown below was cranked up to a high enough level of detail for our homegrown <a href="https://github.com/HubSpot/gc_log_visualizer" target="_blank" rel="noopener">gc_log_visualizer</a> script. The majority of graphs in this document were created with gc_log_visualizer, while others were snapshotted from SignalFX data collected through our <a href="https://github.com/HubSpot/collectd-gcmetrics" target="_blank" rel="noopener">CollectD GC metrics plugin</a>.</p>
<p>Our GC logging params:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-verbosegc -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintAdaptiveSizePolicy -XX:+PrintGCDetails -XX:+PrintGCApplicationStoppedTime -XX:+PrintTenuringDistribution</span><br></pre></td></tr></table></figure>
<h4 id="Starting-Point-Heap-Sizes-and-Overall-Time-Spent-in-GC"><a href="#Starting-Point-Heap-Sizes-and-Overall-Time-Spent-in-GC" class="headerlink" title="Starting Point: Heap Sizes and Overall Time Spent in GC"></a>Starting Point: Heap Sizes and Overall Time Spent in GC</h4><p>With the highly detailed GC logs came the following chart of heap state. Eden size is in red and stays put at its minimum (<code>G1NewSizePercent</code>), 9% of total heap. Tenured size, or Working set + waste, floats in a narrow band between 18-20gb. With Eden a flat line, the total heap line will mirror the Tenured line, just 9% higher.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC1-1.png" alt=""></p>
<p>The black horizontal line just under 15GB marks the <code>InitiatingHeapOccupancyPercent</code> (aka “IHOP”), at its default setting of 45%. The purple squares are the amount of Tenured space reclaimable at the start of a mixed GC event. The floor of the band of purple squares is 5% of heap, the value of <code>G1HeapWastePercent</code>.</p>
<p>The next graph shows a red “+” on each minute boundary and stands for the total percent of wall time the JVM was in STW and doing no useful work. The overall time spent in GC for this HBase instance for this time period is 15-25%. For reference, an application tier server spending 20%+ time in GC is considered stuck in “GC Hell” and in desperate need of tuning.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC2-1.png" alt=""></p>
<h3 id="Tuning-1-Goal-Lower-Total-Time-in-GC-Action-Raise-IHOP"><a href="#Tuning-1-Goal-Lower-Total-Time-in-GC-Action-Raise-IHOP" class="headerlink" title="Tuning #1 Goal: Lower Total Time in GC - Action: Raise IHOP"></a>Tuning #1 Goal: Lower Total Time in GC - Action: Raise IHOP</h3><p>One aspect that stands out clearly in the previous graph of heap sizes is that the working set is well above the IHOP. Tenured being higher than IHOP generally results in an overabundance of MPCMC runs (wastes CPU) and consequently an overabundance of Mixed GC cycles resulting in a higher ratio of expensive GC events vs cheap GC events. By moving IHOP a bit higher than Tenured, we expect fewer Mixed GC events to reclaim larger amounts of space, which should translate to less overall time spent in STW.</p>
<p>Raising the IHOP value on an hbase instance, the following before/after (above/below) graphs show that indeed the frequency of Mixed GC events drops dramatically while the reclaimable amount rises.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC3-1.png" alt=""></p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1Gc4-1.png" alt=""></p>
<p>Considering that at least half of Mixed GC events on this instance took 200-400ms, we expected the reduced amount of Mixed GC events to outweigh any increase in individual Mixed GC times, such that overall GC time would drop. That expectation held true, as overall time spent in GC dropped from 4-12% to 1-8%.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC5-1.png" alt=""></p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC6-1.png" alt=""></p>
<p>The following graphs show before/after on the STW times for all Mixed GC events. Note the drastic drop in frequency while individual STW times don’t seem to change.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC7-1.png" alt=""></p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC8.png" alt=""></p>
<h4 id="Result-Success"><a href="#Result-Success" class="headerlink" title="Result: Success"></a>Result: Success</h4><p>This test was considered successful. We made the change across all HBase clusters to use a significantly larger IHOP value than the default of 45%.</p>
<h3 id="Tuning-2-Goal-Lower-Total-Time-in-GC-Action-Increase-Eden"><a href="#Tuning-2-Goal-Lower-Total-Time-in-GC-Action-Increase-Eden" class="headerlink" title="Tuning #2 Goal: Lower Total Time in GC - Action: Increase Eden"></a>Tuning #2 Goal: Lower Total Time in GC - Action: Increase Eden</h3><p>Fixing the IHOP value to be higher than working set was basically fixing a misconfiguration. There was very little doubt that nonstop MPCMC + Mixed GC events was an inefficient behavior. Increasing Eden size, on the other hand, had a real possibility of increasing all STW times, both Minor and Mixed. GC times are driven by the amount of data being copied (surviving) from one epoch to the next, and databases like HBase are expected to have very large caches. A 10+ GB cache could very well have high churn and thus high object survival rates.</p>
<p>The effective Eden size for our HBase clusters is driven by the minimum Eden value <code>G1NewSizePercent</code> because the <code>MaxGCPauseMillis</code> target of 50ms is never met.</p>
<p>For this test, we raised Eden from 9% to 20% through <code>G1NewSizePercent</code>.</p>
<h4 id="Effects-on-Overall-GC-Time"><a href="#Effects-on-Overall-GC-Time" class="headerlink" title="Effects on Overall GC Time"></a>Effects on Overall GC Time</h4><p>Looking at the following graphs, we see that overall time spent in GC may have dropped a little for this one hour time window from one day to the next.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC9.png" alt=""></p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC10.png" alt=""></p>
<h4 id="Individual-STW-times"><a href="#Individual-STW-times" class="headerlink" title="Individual STW times"></a>Individual STW times</h4><p>Looking at the STW times for just the Minor GC events there is a noticeable jump in the floor of STW times.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC11.png" alt=""></p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC12.png" alt=""></p>
<h4 id="To-space-Exhaustion-Danger"><a href="#To-space-Exhaustion-Danger" class="headerlink" title="To-space Exhaustion Danger"></a>To-space Exhaustion Danger</h4><p>As mentioned in the <a href="http://product.hubspot.com/g1gc-fundamentals-lessons-from-taming-garbage-collection?hs_preview=zL3BfQaN-4049945892" target="_blank" rel="noopener">G1GC Foundational blog post</a>, <code>G1ReservePercent</code> is ignored when the minimum end of the Eden range is used. The working set on a few of our HBase clusters is in the 70-75% range, which combined with a min Eden of 20% would leave only 5-10% of heap free for emergency circumstances. The downside of running out of free space, thus triggering To-space Exhaustion, is a 20+ sec GC pause and the effective death of the HBase instance. While the instance would recover, the other HBase instances in the cluster would consider it long dead before the GC pause completed.</p>
<h4 id="Result-Failure"><a href="#Result-Failure" class="headerlink" title="Result: Failure"></a>Result: Failure</h4><p>The overall time spent in GC did drop a little as theoretically expected, unfortunately the low end of Minor GC stw times increased by a similar percent. In addition, the risk for To-space exhaustion increased. The approach of increasing <code>G1NewSizePercent</code> to reduce overall time spent in GC didn’t look promising and was not rolled out to any clusters.</p>
<h3 id="Tuning-3-Goal-Reduce-Individual-STW-Durations-Action-SurvivorRatio-amp-MaxTenuringThreshold"><a href="#Tuning-3-Goal-Reduce-Individual-STW-Durations-Action-SurvivorRatio-amp-MaxTenuringThreshold" class="headerlink" title="Tuning #3 Goal: Reduce Individual STW Durations - Action: SurvivorRatio &amp; MaxTenuringThreshold"></a>Tuning #3 Goal: Reduce Individual STW Durations - Action: SurvivorRatio &amp; MaxTenuringThreshold</h3><p>In the previous tuning approach, we found that STW times increased as Eden size increased. We took some time to dig a little deeper into Survivor space to determine if there was any To-space overflow or if objects could be promoted faster to reduce the amount of object copying being done. To collect the Survivor space tenuring distribution data in the GC logs we enabled <code>-XX:+PrintTenuringDistribution</code> and restarted a few select instances.</p>
<p>To-space overflow is the phenomenon where the Survivor To space isn’t large enough to fit all the live data in Eden at the end of an epoch. Any data collected after Survivor To is full is added to Free regions, which are then added to Tenured. If this overflow is transient data, putting it in Tenured is inefficient as it will be expensive to clean out. If that was the case, we’d need to increase <code>SurvivorRatio</code>.</p>
<p>On the other hand, consider a use case where any object that survives two epochs will also survive ten epochs. In that case, by ensuring that any object that survives a second epoch is immediately promoted to Tenured, we would see a performance improvement since we wouldn’t be copying it around in the GC events that followed.</p>
<p>Here’s some data collected from the <code>PrintTenuringDistribution</code> parameter:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Desired survivor size 192937984 bytes, new threshold 2 (max 15)</span><br><span class="line"></span><br><span class="line">- age 1: 152368032 bytes, 152368032 total</span><br><span class="line"></span><br><span class="line">- age 2: 147385840 bytes, 299753872 total</span><br><span class="line"></span><br><span class="line">[Eden: 2656.0M(2656.0M)-&gt;0.0B(2624.0M) Survivors: 288.0M-&gt;320.0M Heap: 25.5G(32.0G)-&gt;23.1G(32.0G)]</span><br></pre></td></tr></table></figure>
<p>An Eden size of 2656 MB with <code>SurvivorRatio=8</code> (default) yields a 2656/8 = 332 MB survivor space. In the example entries we see enough room to hold two ages of survivor objects. The second age here is 5mb smaller than the first age, indicating that in the interval between GC events, only 5/152 = 3.3% of the data was transient. We can reasonably assume the other 97% of the data is some kind of caching. By setting <code>-XX:MaxTenuringThreshold=1</code>, we optimize for the 97% of cached data to be promoted to Tenured after surviving its second epoch and hopefully shave a few ms of object copy time off each GC event.</p>
<h4 id="Result-Theoretical-Success"><a href="#Result-Theoretical-Success" class="headerlink" title="Result: Theoretical Success"></a>Result: Theoretical Success</h4><p>Unfortunately we don’t have any nice graphs available to show these effects in isolation. We consider the theory sound and rolled out -XX:MaxTenuringThreshold=1 to all our clusters.</p>
<h3 id="Tuning-4-Goal-Eliminate-Long-STW-Events-Action-G1MixedGCCountTarget-amp-G1HeapWastePercent"><a href="#Tuning-4-Goal-Eliminate-Long-STW-Events-Action-G1MixedGCCountTarget-amp-G1HeapWastePercent" class="headerlink" title="Tuning #4 Goal: Eliminate Long STW Events - Action: G1MixedGCCountTarget &amp; G1HeapWastePercent"></a>Tuning #4 Goal: Eliminate Long STW Events - Action: G1MixedGCCountTarget &amp; G1HeapWastePercent</h3><p>Next, we wanted to see what we could do about eliminating the high end of Mixed GC pauses. Looking at a 5 minute interval of our Mixed GC STW times, we saw a pattern of sharply increasing pauses across each cycle of 6 mixed GCs:</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC13.png" alt=""></p>
<p>That in and of itself should not be considered unusual, after all that behavior is how the G1GC algorithm got it’s name. Each Mixed GC event will evacuate <code>1/G1MixedGCCountTarget</code> of the high-waste regions (regions with the most non-live data). Since it prioritizes regions with the most garbage, each successive Mixed GC event will be evicting regions with more and more live objects. The chart shows the performance effects of clearing out regions with more and more live data: the Mixed event times start at 100ms at the beginning of a mixed GC cycle and range upwards past 600ms by the end.</p>
<p>In our case, we were seeing occasional pauses at the end of some cycles that were several seconds long. Even though they were rare enough that our average pause time was reasonable, pauses that long are still a serious concern.</p>
<p>Two levers in combination can be used together to lessen the “scraping the bottom of the barrel” effect of cleaning up regions with a lot of live data:</p>
<p><code>G1HeapWastePercent</code>: default (5) → 10. Allow twice as much wasted space in Tenured. Having 5% waste resulted in 6 of the 8 potential Mixed GC events occurring in each Mixed GC cycle. Bumping to 10% waste should chop off 1-2 more of the most expensive events of the Mixed GC cycle.</p>
<p><code>G1MixedGCCountTarget</code>: default (8) → 16. Double the target number of Mixed GC events each Mixed GC cycle, but halve the work done by each GC event. Though it’s an increase to the number of GC events that are Mixed GC events, STW times of individual Mixed events should drop noticeably.</p>
<p>In combination, we expected doubling the target count to drop the average Mixed GC time, and increasing the allowable waste to eliminate the most expensive Mixed GC time. There should be some synergy, as more heap waste should also mean regions are on average slightly less live when collected.</p>
<p>Waste heap values of 10% and 15% were both examined in a test environment. (Don’t be alarmed by the high average pause times–this test environment was running under heavy load, on less capable hardware than our production servers.)</p>
<p>Above: 10% heap waste; below: 15% heap waste:</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC14.png" alt=""></p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC15.png" alt=""></p>
<p>The results are very similar. 15% performed slightly better, but in the end we decided that 15% waste was unnecessarily much. 10% was enough to clear out the “scraping the bottom of the barrel” effect such that the 1+ sec Mixed GC STW times all but disappeared in production.</p>
<h4 id="Result-Success-1"><a href="#Result-Success-1" class="headerlink" title="Result: Success"></a>Result: Success</h4><p>Doubling <code>G1MixedGCCountTarget</code> from 8 to 16 and <code>G1HeapWastePercent</code> from 5 to 10 succeeded in eliminating the frequent 1s+ Mixed GC STW times. We kept these changes and rolled them out across all our clusters.</p>
<h3 id="Tuning-5-Goal-Stop-Losing-Nodes-Heap-Size-and-HBase-Configs"><a href="#Tuning-5-Goal-Stop-Losing-Nodes-Heap-Size-and-HBase-Configs" class="headerlink" title="Tuning #5 Goal: Stop Losing Nodes: Heap Size and HBase Configs"></a>Tuning #5 Goal: Stop Losing Nodes: Heap Size and HBase Configs</h3><p>While running load tests to gauge the effects of the parameters above, we also began to dig into what looked like evidence of memory leaks in a production cluster. In the following graph we see the heap usage slowly grow over time until To-space Exhaustion, triggering a Full GC with a long enough pause to get the HBase instance booted from the cluster and killed:</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC16.png" alt=""></p>
<p>We’ve got several HBase clusters, and only one cluster occasionally showed this type of behavior.  If this issue were a memory leak, we’d expect the issue to arise more broadly, so it looks like HBase is using more memory in this cluster than we expected. To understand why, we looked into the heap breakdown of our RegionServers. The vast majority of an HBase RegionServer’s Tenured space is allocated to three main areas:</p>
<ul>
<li><strong>Memstore</strong>: region server’s write cache; default configuration caps this at 40% of heap.</li>
<li><strong>Block Cache</strong>: region server’s read cache; default config caps at 40% of heap.</li>
<li><strong>Overhead</strong>: the vast majority of HBase’s in-memory overhead is contained in a “static index”. The size of this index isn’t capped or configurable, but HBase assumes this won’t be an issue since the combined cap for memstore and block cache can’t exceed 80%.</li>
</ul>
<p>We have metrics for the size of each of these, from the RegionServer’s JMX stats: “memStoreSize,” “blockCacheSize,” and “staticIndexSize.” The stats from our clusters show that HBase will use basically all of the block cache capacity you give it, but memstore and static index sizes depend on cluster usage and tables. Memstore fluctuates over time, while static index size depends on the RegionServer’s StoreFile count and average row key size.</p>
<p>It turned out, for the cluster in question, that the HBase caches and overhead combined were actually using more space than our JVM was tuned to handle. Not only were memstore and block cache close to capacity—12 GB block cache, memstore rising past 10GB—but the static index size was unexpectedly large, at 6 GB. Combined, this put desired Tenured space at 28+ GB, while our IHOP was set at 24 GB, so the upward trend of our Tenured space was just the legitimate memory usage of the RegionServer.</p>
<p>With this in mind, we judged the maximum expected heap use for each cluster’s RegionServers by looking at the cluster maximum memstore size, block cache size, and static index size over the previous month, and assuming max expected usage to be 110% of each value. We then used that number to set the block cache and memstore size caps (<code>hfile.block.cache.size</code> &amp; <code>hbase.regionserver.global.memstore.size</code>) in our HBase configs.</p>
<p>The fourth component of Tenured space is the heap waste, in our case 10% of the heap size. We could now confidently tune our IHOP threshold by summing the max expected memstore, block cache, static index size, 10% heap for heap waste, and finally 10% more heap as a buffer to avoid constant mixed GCs when working set is maxed (as described in Tuning #1).</p>
<p>However, before we went ahead and blindly set this value, we had to consider the uses of heap other than Tenured space. Eden requires a certain amount of heap (determined by <code>G1NewSizePercent</code>), and a certain amount (default 10%) is Reserved free space. IHOP + Eden + Reserved must be ≤ 100% in order for a tuning to make sense; in cases where our now-precisely-calculated IHOP was too large for this to be possible, we had to expand our RegionServer heaps. To determine minimum acceptable heap size, assuming 10% Reserved space, we used this formula:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Heap ≥ (M + B + O + E) ÷ 0.7</span><br><span class="line"></span><br><span class="line">M = max expected memstore size</span><br><span class="line">B = max expected block cache size</span><br><span class="line">O = max expected overhead (static index)</span><br><span class="line">E = minimum Eden size</span><br></pre></td></tr></table></figure>
<p>When those four components add up to ≤ 70% of the heap, then there will be enough room for 10% Reserved space, 10% heap waste, and 10% buffer between max working set and IHOP.</p>
<h4 id="Result-Success-2"><a href="#Result-Success-2" class="headerlink" title="Result: Success"></a>Result: Success</h4><p>We reviewed memory usage of each of our clusters and calculated correct heap sizes and IHOP thresholds for each. Rolling out these changes immediately ended the To-space Exhaustion events we were seeing on the problematic cluster.</p>
<h3 id="Tuning-6-Goal-Eliminate-Long-STW-Events-Action-Increase-G1-Region-Size"><a href="#Tuning-6-Goal-Eliminate-Long-STW-Events-Action-Increase-G1-Region-Size" class="headerlink" title="Tuning #6 Goal: Eliminate Long STW Events - Action: Increase G1 Region Size"></a>Tuning #6 Goal: Eliminate Long STW Events - Action: Increase G1 Region Size</h3><p>We’d rolled out HBase block cache &amp; memstore config changes, changes to <code>G1HeapWastePercent</code> and <code>G1MixedGCCountTarget</code>, and an increase in heap size on a couple clusters (32 GB → 40+ GB) to accommodate larger IHOP. In general things were smooth, but there were still occasional Mixed GC events taking longer than we were comfortable with, especially on the clusters whose heap had increased. Using gc_log_visualizer, we looked into what phase of Mixed GC was the most volatile and noticed that Scan RS times correlated:</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC17.png" alt=""></p>
<p>A few Google searches indicated that Scan RS time output in the GC logs is the time taken examining all the regions referencing the tenured regions being collected. In our most recent tuning changes, heap size had been bumped up, however the <code>G1HeapRegionSize</code> remained fixed at 16 MB. Increasing the <code>G1HeapRegionSize</code> to 32 MB eliminated those high scan times:</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC18.png" alt=""></p>
<h4 id="Result-Success-3"><a href="#Result-Success-3" class="headerlink" title="Result: Success"></a>Result: Success</h4><p>Halving the G1 region count cleared out the high volatility in Scan RS times. According to G1GC documentation, the ideal region count is 2048, so 16 MB regions were perfect for a 32 GB heap. However, this tuning case led us to believe that for HBase heaps without a clear choice of region size, in our case 40+ GB, it’s much better to err on the side of fewer, larger regions.</p>
<h3 id="Tuning-7-Goal-Preventing-RegionServer-To-space-Exhaustion-Action-Extra-Heap-as-Buffer"><a href="#Tuning-7-Goal-Preventing-RegionServer-To-space-Exhaustion-Action-Extra-Heap-as-Buffer" class="headerlink" title="Tuning #7 Goal: Preventing RegionServer To-space Exhaustion - Action: Extra Heap as Buffer"></a>Tuning #7 Goal: Preventing RegionServer To-space Exhaustion - Action: Extra Heap as Buffer</h3><p>At this point, our RegionServers were tuned and running much shorter and less frequent GC Events. IHOP rested above Tenured while Tenured + Eden remained under the target of 90% total heap. Yet once in awhile, a RegionServer would still die from a To-space exhaustion triggered Full GC event as shown in the following graph.</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC19.png" alt=""></p>
<p>It looks like we did everything right—there’s lot’s of reclaimable space and Tenured space drops well below IHOP with each Mixed GC. But right at the end, heap usage spikes up and we hit To-space Exhaustion. And while it’s likely the HBase client whose requests caused this problem could be improved to avoid this*, we can’t rely on our various HBase clients to behave perfectly all the time.</p>
<p>In the scenario above, very bursty traffic caused Tenured space to fill up the heap before the MPCMC could complete and enable a Mixed GC run. To tune around this, we simply added heap space**, while adjusting IHOP and <code>G1NewSizePercent</code> down to keep them at the same GB values they had been at before. By doing this we increased the buffer of free space in the heap above our original 10% default, for additional protection against spikes in memory usage.</p>
<h4 id="Result-Success-4"><a href="#Result-Success-4" class="headerlink" title="Result: Success"></a>Result: Success</h4><p>Increasing heap buffer space on clusters whose HBase clients are known to be occasionally bursty has all but eliminated Full GC events on our RegionServers.</p>
<h4 id="Notes"><a href="#Notes" class="headerlink" title="Notes:"></a>Notes:</h4><p>Block cache churn correlates very closely with time spent in Mixed GC events on our clusters (see chart below). A high volume of Get and Scan requests with caching enabled unnecessarily (e.g. requested data isn’t expected to be in cache and isn’t expected to be requested again soon) will increase cache churn as data is evicted from cache to make room for the Get/Scan results. This will raise the RegionServer’s time in GC and could contribute to instability as described in this section.</p>
<p>Chart: % time in Mixed GC is in yellow (left axis); MB/sec cache churn is in blue (right axis):</p>
<p><img src="/assets/images/2016/05/10/g1gc-tuning-your-hbase-cluster/G1GC20.png" alt=""></p>
<p>Another potential way to tune around this issue is by increasing <code>ConcGCThreads</code> (default is <code>1/4 ParallelGCThreads</code>). <code>ConcGCThreads</code> is the number of threads used to do the MPCMC, so increasing it could mean the MPCMC finishes sooner and the RegionServer can start a Mixed GC before Tenured space fills the heap. At HubSpot we’ve been satisfied with the results of increasing our heap size and haven’t tried experimenting with this value.</p>
<h3 id="Overall-Results-Goals-Achieved"><a href="#Overall-Results-Goals-Achieved" class="headerlink" title="Overall Results: Goals Achieved!"></a>Overall Results: Goals Achieved!</h3><p>After these cycles of debugging and tuning G1GC for our HBase clusters, we’ve improved performance in all the areas we were seeing problems originally:</p>
<ul>
<li><strong>Stability</strong>: no more To-space Exhaustion events causing Full GCs.</li>
<li><strong>99th percentile performance</strong>: greatly reduced frequency of long STW times.</li>
<li><strong>Avg. performance</strong>: overall time spent in GC STW significantly reduced.</li>
</ul>
<h3 id="Summary-How-to-Tune-Your-HBase-Cluster"><a href="#Summary-How-to-Tune-Your-HBase-Cluster" class="headerlink" title="Summary: How to Tune Your HBase Cluster"></a>Summary: How to Tune Your HBase Cluster</h3><p>Based on our findings, here’s how we recommend you tune G1GC for your HBase cluster(s):</p>
<h4 id="Before-you-start-GC-amp-HBase-monitoring"><a href="#Before-you-start-GC-amp-HBase-monitoring" class="headerlink" title="Before you start: GC &amp; HBase monitoring"></a>Before you start: GC &amp; HBase monitoring</h4><ul>
<li>Track block cache, memstore &amp; static index size metrics for your clusters in whatever tool you use for charts and monitoring, if you don’t already. These are found in the RegionServer JMX metrics:<ul>
<li>“memStoreSize”</li>
<li>“blockCacheSize”</li>
<li>“staticIndexSize”</li>
</ul>
</li>
<li>You can use our <a href="https://github.com/HubSpot/collectd-gcmetrics" target="_blank" rel="noopener">collectd plugin</a> to track G1GC performance over time, and our <a href="https://github.com/HubSpot/gc_log_visualizer" target="_blank" rel="noopener">gc_log_visualizer</a> for insight on specific GC logs. In order to use these you’ll have to log GC details on your RegionServers:<ul>
<li>-Xloggc:$GC_LOG_PATH</li>
<li>-verbosegc</li>
<li>-XX:+PrintGC</li>
<li>-XX:+PrintGCDateStamps</li>
<li>-XX:+PrintAdaptiveSizePolicy</li>
<li>-XX:+PrintGCDetails</li>
<li>-XX:+PrintGCApplicationStoppedTime</li>
<li>-XX:+PrintTenuringDistribution</li>
<li>Also recommended is some kind of GC log rotation, e.g.:<ul>
<li>-XX:+UseGCLogFileRotation</li>
<li>-XX:NumberOfGCLogFiles=5</li>
<li>-XX:GCLogFileSize=20M</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Step-0-Recommended-Defaults"><a href="#Step-0-Recommended-Defaults" class="headerlink" title="Step 0: Recommended Defaults"></a>Step 0: Recommended Defaults</h4><ul>
<li>We recommend the following JVM parameters and values as defaults for your HBase RegionServers (as explained in <a href="http://product.hubspot.com/blog/g1gc-tuning-your-hbase-cluster#OriginalGCTuning" target="_blank" rel="noopener">Original GC Tuning State</a>):<ul>
<li>-XX:+UseG1GC</li>
<li>-XX:+UnlockExperimentalVMOptions</li>
<li>-XX:MaxGCPauseMillis=50<br>This value is intentionally very low and doesn’t actually represent a pause time upper bound. We recommend keeping it low to pin Eden to the low end of its range (see Tuning #2).</li>
<li>-XX:-OmitStackTraceInFastThrow</li>
<li>-XX:ParallelGCThreads=8+(logical processors-8)(5/8)</li>
<li>-XX:+ParallelRefProcEnabled</li>
<li>-XX:+PerfDisableSharedMem</li>
<li>-XX:-ResizePLAB</li>
</ul>
</li>
</ul>
<h4 id="Step-1-Determine-maximum-expected-HBase-usage"><a href="#Step-1-Determine-maximum-expected-HBase-usage" class="headerlink" title="Step 1: Determine maximum expected HBase usage"></a>Step 1: Determine maximum expected HBase usage</h4><ul>
<li>As discussed in the Tuning #5 section, before you can properly tune your cluster you need to know your max expected block cache, memstore, and static index usage.<ul>
<li>Using the RegionServer JMX metrics mentioned above, look for the maximum value of each metric across the cluster:<ul>
<li>Maximum block cache size.</li>
<li>Maximum memstore size.</li>
<li>Maximum static index size.</li>
</ul>
</li>
<li>Scale each maximum by 110%, to accommodate even for slight increase in max usage. This is your <strong>usage cap</strong> for that metric: e.g. a 10 GB max recorded memstore → 11 GB <strong>memstore cap</strong>.<ul>
<li>Ideally, you’ll have these metrics tracked for the past week or month, and you can find the maximum values over that time. If not, be more generous than 110% when calculating memstore and static index caps. Memstore size especially can vary widely over time.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Step-2-Set-Heap-size-IHOP-and-Eden-size"><a href="#Step-2-Set-Heap-size-IHOP-and-Eden-size" class="headerlink" title="Step 2: Set Heap size, IHOP, and Eden size"></a>Step 2: Set Heap size, IHOP, and Eden size</h4><ul>
<li>Start with Eden size relatively low: 8% of heap is a good initial value if you’re not sure.<ul>
<li>-XX:G1NewSizePercent=8</li>
<li>See Tuning #2 for more about Eden sizing.<ul>
<li>Increasing Eden size will increase individual GC pauses, but slightly reduce overall % time spent in GC.</li>
<li>Decreasing Eden size will have the opposite effect: shorter pauses, slightly more overall time in GC.</li>
</ul>
</li>
</ul>
</li>
<li>Determine necessary heap size, using Eden size and usage caps from Step 1:<ul>
<li>From Tuning #5: Heap ≥ (M + B + O + E) ÷ 0.7<ul>
<li>M = memstore cap, GB</li>
<li>B = block cache cap, GB</li>
<li>O = static index cap, GB</li>
<li>E = Eden size, GB</li>
</ul>
</li>
<li>Set JVM args for fixed heap size based on the calculated value, e.g:<ul>
<li>-Xms40960m -Xmx40960m</li>
</ul>
</li>
</ul>
</li>
<li>Set IHOP in the JVM, based on usage caps and heap size:<ul>
<li>IHOP = (memstore cap’s % heap + block cache cap’s % heap + overhead cap’s % heap + 20)</li>
<li>-XX:InitiatingHeapOccupancyPercent=IHOP</li>
</ul>
</li>
</ul>
<h4 id="Step-3-Adjust-HBase-configs-based-on-usage-caps"><a href="#Step-3-Adjust-HBase-configs-based-on-usage-caps" class="headerlink" title="Step 3: Adjust HBase configs based on usage caps"></a>Step 3: Adjust HBase configs based on usage caps</h4><ul>
<li>Set block cache cap and memstore cap ratios in HBase configs, based on usage caps and total heap size. In hbase-site.xml:<ul>
<li><code>hfile.block.cache.size</code> → block cache cap ÷ heap size</li>
<li><code>hbase.regionserver.global.memstore.size</code> → memstore cap ÷ heap size</li>
</ul>
</li>
</ul>
<h4 id="Step-4-Adjust-additional-recommended-JVM-flags-for-GC-performance"><a href="#Step-4-Adjust-additional-recommended-JVM-flags-for-GC-performance" class="headerlink" title="Step 4: Adjust additional recommended JVM flags for GC performance"></a>Step 4: Adjust additional recommended JVM flags for GC performance</h4><ul>
<li>From Tuning #3:<ul>
<li>-XX:MaxTenuringThreshold=1</li>
</ul>
</li>
<li>From Tuning #4:<ul>
<li>-XX:G1HeapWastePercent=10</li>
<li>-XX:G1MixedGCCountTarget=16</li>
</ul>
</li>
<li>From Tuning #6:<ul>
<li>-XX:G1HeapRegionSize=#M</li>
<li><code>#</code> must be a power of 2, in range [1..32].</li>
<li>Ideally, # is such that: heap size ÷ # MB = 2048 regions.</li>
<li>If your heap size doesn’t provide a clear choice for region size, err on the side of fewer, larger regions. Larger regions reduce GC pause time volatility.</li>
</ul>
</li>
</ul>
<h4 id="Step-5-Run-it"><a href="#Step-5-Run-it" class="headerlink" title="Step 5: Run it!"></a>Step 5: Run it!</h4><ul>
<li>Restart your RegionServers with these settings and see how they look.<ul>
<li>Remember that you can adjust Eden size as described above, to optimize either for shorter individual GCs or for less overall time in GC. If you do, make sure to maintain Eden + IHOP ≤ 90%.</li>
<li>If your HBase clients can have very bursty traffic, consider adding heap space outside of IHOP and Eden (so that IHOP + Eden adds up to 80%, for example).<ul>
<li>Remember to update % and ratio configs along with the new heap size.</li>
<li>Details and further suggestions about this found in Tuning #7.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Further-reference"><a href="#Further-reference" class="headerlink" title="Further reference:"></a>Further reference:</h3><ul>
<li><a href="http://product.hubspot.com/blog/g1gc-fundamentals-lessons-from-taming-garbage-collection" target="_blank" rel="noopener">G1GC Fundamentals (HubSpot blog)</a></li>
<li><a href="https://blogs.oracle.com/poonam/entry/understanding_g1_gc_logs" target="_blank" rel="noopener">Understanding G1GC Logs (Oracle blog)</a></li>
<li><a href="https://software.intel.com/en-us/blogs/2014/06/18/part-1-tuning-java-garbage-collection-for-hbase" target="_blank" rel="noopener">Tuning HBase Garbage Collection (Intel blog)</a></li>
</ul>
<p>This blog post was co-authored by Staff Software Engineer Eric Abbott. </p>
<hr>
<ul>
<li>原文链接：<a href="http://product.hubspot.com/blog/g1gc-tuning-your-hbase-cluster" target="_blank" rel="noopener">Tuning G1GC For Your HBase Cluster</a></li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/HBase/" rel="tag"># HBase</a>
          
            <a href="/tags/Tuning/" rel="tag"># Tuning</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/2016-03-10-hadoop-raid/" rel="next" title="Hadoop Raid - 实战经验总结">
                <i class="fa fa-chevron-left"></i> Hadoop Raid - 实战经验总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/2016-05-12-evaluation-deep-learning-toolkits/" rel="prev" title="Evaluation of Deep Learning Toolkits">
                Evaluation of Deep Learning Toolkits <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/assets/images/hyperj.jpg"
                alt="HyperJ" />
            
              <p class="site-author-name" itemprop="name">HyperJ</p>
              <p class="site-description motion-element" itemprop="description">Knowledge makes me travel through time and space.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">182</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">65</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">202</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://gist.github.com/HyperJ/" target="_blank" title="Gist" rel="external nofollow"><i class="fa fa-fw fa-github-alt"></i>Gist</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://github.com/HyperJ" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://blog.hyperj.net" target="_blank" title="Blog" rel="external nofollow"><i class="fa fa-fw fa-bookmark-o"></i>Blog</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.linkedin.com/in/hyperj" target="_blank" title="Linkedin" rel="external nofollow"><i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/han_xiaoyang" title="寒小阳" target="_blank">寒小阳</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/odailidong" title="dailidong" target="_blank">dailidong</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://dmlcoding.com" title="Time渐行渐远" target="_blank">Time渐行渐远</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://91fz.org" title="程序员疯子" target="_blank">程序员疯子</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.bcmeng.com" title="编程小梦" target="_blank">编程小梦</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://hexiaoqiao.github.io" title="Hexiaoqiao" target="_blank">Hexiaoqiao</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/90ab66c248e6" title="占小狼" target="_blank">占小狼</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Original-GC-Tuning-State"><span class="nav-text">Original GC Tuning State</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Starting-Point-Heap-Sizes-and-Overall-Time-Spent-in-GC"><span class="nav-text">Starting Point: Heap Sizes and Overall Time Spent in GC</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-1-Goal-Lower-Total-Time-in-GC-Action-Raise-IHOP"><span class="nav-text">Tuning #1 Goal: Lower Total Time in GC - Action: Raise IHOP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Success"><span class="nav-text">Result: Success</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-2-Goal-Lower-Total-Time-in-GC-Action-Increase-Eden"><span class="nav-text">Tuning #2 Goal: Lower Total Time in GC - Action: Increase Eden</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Effects-on-Overall-GC-Time"><span class="nav-text">Effects on Overall GC Time</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Individual-STW-times"><span class="nav-text">Individual STW times</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#To-space-Exhaustion-Danger"><span class="nav-text">To-space Exhaustion Danger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Failure"><span class="nav-text">Result: Failure</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-3-Goal-Reduce-Individual-STW-Durations-Action-SurvivorRatio-amp-MaxTenuringThreshold"><span class="nav-text">Tuning #3 Goal: Reduce Individual STW Durations - Action: SurvivorRatio &amp; MaxTenuringThreshold</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Theoretical-Success"><span class="nav-text">Result: Theoretical Success</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-4-Goal-Eliminate-Long-STW-Events-Action-G1MixedGCCountTarget-amp-G1HeapWastePercent"><span class="nav-text">Tuning #4 Goal: Eliminate Long STW Events - Action: G1MixedGCCountTarget &amp; G1HeapWastePercent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Success-1"><span class="nav-text">Result: Success</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-5-Goal-Stop-Losing-Nodes-Heap-Size-and-HBase-Configs"><span class="nav-text">Tuning #5 Goal: Stop Losing Nodes: Heap Size and HBase Configs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Success-2"><span class="nav-text">Result: Success</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-6-Goal-Eliminate-Long-STW-Events-Action-Increase-G1-Region-Size"><span class="nav-text">Tuning #6 Goal: Eliminate Long STW Events - Action: Increase G1 Region Size</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Success-3"><span class="nav-text">Result: Success</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuning-7-Goal-Preventing-RegionServer-To-space-Exhaustion-Action-Extra-Heap-as-Buffer"><span class="nav-text">Tuning #7 Goal: Preventing RegionServer To-space Exhaustion - Action: Extra Heap as Buffer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Result-Success-4"><span class="nav-text">Result: Success</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Notes"><span class="nav-text">Notes:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Overall-Results-Goals-Achieved"><span class="nav-text">Overall Results: Goals Achieved!</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary-How-to-Tune-Your-HBase-Cluster"><span class="nav-text">Summary: How to Tune Your HBase Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Before-you-start-GC-amp-HBase-monitoring"><span class="nav-text">Before you start: GC &amp; HBase monitoring</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-0-Recommended-Defaults"><span class="nav-text">Step 0: Recommended Defaults</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-1-Determine-maximum-expected-HBase-usage"><span class="nav-text">Step 1: Determine maximum expected HBase usage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-2-Set-Heap-size-IHOP-and-Eden-size"><span class="nav-text">Step 2: Set Heap size, IHOP, and Eden size</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-3-Adjust-HBase-configs-based-on-usage-caps"><span class="nav-text">Step 3: Adjust HBase configs based on usage caps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-4-Adjust-additional-recommended-JVM-flags-for-GC-performance"><span class="nav-text">Step 4: Adjust additional recommended JVM flags for GC performance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-5-Run-it"><span class="nav-text">Step 5: Run it!</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Further-reference"><span class="nav-text">Further reference:</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2009 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HyperJ</span>

  

  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.2.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  
  <script type="text/javascript" src="/js/src/exturl.js?v=6.2.0"></script>


  

</body>
</html>
